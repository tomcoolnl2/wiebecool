name: Cypress Tests with Dependency and Artifact Caching

on: push

jobs:
    install:
        runs-on: ubuntu-22.04
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Cypress install
              uses: cypress-io/github-action@v6
              with:
                  # Disable running of tests within install job
                  runTests: false
                  build: npm run build

            - name: Save build folder
              uses: actions/upload-artifact@v4
              with:
                  name: build
                  if-no-files-found: error
                  path: build

    cypress-run:
        runs-on: ubuntu-22.04
        needs: install
        container:
            image: cypress/browsers:node-20.9.0-chrome-118.0.5993.88-1-ff-118.0.2-edge-118.0.2088.46-1
            options: --user 1001
        strategy:
            # don't fail the entire matrix on failure
            fail-fast: false
            matrix:
                # run copies of the current job in parallel
                containers: [1, 2, 3, 4, 5]
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Download the build folder
              uses: actions/download-artifact@v4
              with:
                  name: build

            - name: Cypress run
              uses: cypress-io/github-action@v6
              with:
                  record: true
                  parallel: true
                  group: 'UI-Chrome'
                  start: npm start
                  browser: chrome
